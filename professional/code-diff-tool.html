<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Comparison Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
        }

        .upload-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .upload-box {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: white;
            transition: all 0.3s;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: #f0f0ff;
        }

        .upload-box h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .upload-box input[type="file"] {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .upload-btn:hover {
            transform: scale(1.05);
        }

        .file-name {
            margin-top: 10px;
            color: #666;
            font-style: italic;
            min-height: 20px;
        }

        .language-section {
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .language-section label {
            font-weight: 600;
            color: #333;
        }

        .language-section select {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            cursor: pointer;
        }

        .detected-lang {
            padding: 10px 20px;
            background: #e8f4f8;
            border-radius: 8px;
            color: #333;
            font-weight: 600;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .comparison-container {
            padding: 30px;
            display: none;
        }

        .comparison-header {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            font-weight: 600;
            font-size: 1.2em;
            color: #333;
        }

        .comparison-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .code-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            overflow-x: auto;
        }

        .code-section {
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        .section-number {
            font-weight: 700;
            padding: 8px 12px;
            color: white;
            font-size: 14px;
            display: inline-block;
            min-width: 40px;
            text-align: center;
        }

        .code-block {
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .label-text {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 700;
            font-style: italic;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: inline-block;
        }

        .green {
            background: #d4edda;
        }

        .green .section-number {
            background: #28a745;
        }

        .yellow {
            background: #fff3cd;
        }

        .yellow .section-number {
            background: #ffc107;
        }

        .orange {
            background: #ffe8cc;
        }

        .orange .section-number {
            background: #fd7e14;
        }

        .red {
            background: #f8d7da;
        }

        .red .section-number {
            background: #dc3545;
        }

        .stats-container {
            padding: 30px;
            background: #f8f9fa;
            border-top: 2px solid #e0e0e0;
            display: none;
        }

        .stats-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .green-stat {
            color: #28a745;
        }

        .yellow-stat {
            color: #ffc107;
        }

        .orange-stat {
            color: #fd7e14;
        }

        .red-stat {
            color: #dc3545;
        }

        .blue-stat {
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #667eea;
        }

        @media (max-width: 768px) {

            .upload-section,
            .comparison-header,
            .comparison-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="../assets/css/styles.css" />
</head>

<script>
    fetch("../assets/includes/navbar-professional.html")
        .then(response => response.text())
        .then(data => {
            document.getElementById("navbar").innerHTML = data;
        });

    fetch("../assets/includes/darkmode.html")
        .then(response => response.text())
        .then(data => {
            document.body.insertAdjacentHTML('afterbegin', data);
        });
</script>

<body>
    <div id="navbar"></div>
    <div class="container">
        <div class="header">
            <h1>üîç Code Comparison Tool</h1>
            <p>Upload two code files to see intelligent side-by-side differences</p>
        </div>

        <div class="controls">
            <div class="upload-section">
                <div class="upload-box">
                    <h3>üìÑ Old File</h3>
                    <label for="oldFile">
                        <button class="upload-btn" onclick="document.getElementById('oldFile').click()">
                            Choose File
                        </button>
                    </label>
                    <input type="file" id="oldFile"
                        accept=".py,.js,.java,.cpp,.c,.cs,.rb,.php,.go,.rs,.swift,.kt,.ts,.jsx,.tsx,.html,.css,.sql,.sh,.bash,.r,.m,.scala,.perl,.lua">
                    <div class="file-name" id="oldFileName"></div>
                </div>

                <div class="upload-box">
                    <h3>üìÑ New File</h3>
                    <label for="newFile">
                        <button class="upload-btn" onclick="document.getElementById('newFile').click()">
                            Choose File
                        </button>
                    </label>
                    <input type="file" id="newFile"
                        accept=".py,.js,.java,.cpp,.c,.cs,.rb,.php,.go,.rs,.swift,.kt,.ts,.jsx,.tsx,.html,.css,.sql,.sh,.bash,.r,.m,.scala,.perl,.lua">
                    <div class="file-name" id="newFileName"></div>
                </div>
            </div>

            <div class="language-section">
                <label>Language:</label>
                <select id="languageSelect">
                    <option value="auto">Auto-detect</option>
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="java">Java</option>
                    <option value="cpp">C++</option>
                    <option value="c">C</option>
                    <option value="csharp">C#</option>
                    <option value="ruby">Ruby</option>
                    <option value="php">PHP</option>
                    <option value="go">Go</option>
                    <option value="rust">Rust</option>
                    <option value="swift">Swift</option>
                    <option value="kotlin">Kotlin</option>
                    <option value="typescript">TypeScript</option>
                    <option value="html">HTML</option>
                    <option value="css">CSS</option>
                    <option value="sql">SQL</option>
                    <option value="idk">I don't know</option>
                </select>
                <div class="detected-lang" id="detectedLang" style="display: none;"></div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-primary" onclick="compareFiles()">Compare Files</button>
                <button class="btn btn-secondary" onclick="downloadPDF()" id="downloadBtn"
                    style="display: none;">Download PDF Report</button>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            Analyzing files...
        </div>

        <div class="comparison-container" id="comparisonContainer">
            <div class="comparison-header">
                <div>Old File</div>
                <div>New File</div>
            </div>
            <div class="comparison-content" id="comparisonContent">
            </div>
        </div>

        <div class="stats-container" id="statsContainer">
            <h2 class="stats-title">üìä Comparison Statistics</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value blue-stat" id="totalLines">0</div>
                    <div class="stat-label">Total Lines Compared</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value blue-stat" id="similarity">0%</div>
                    <div class="stat-label">Overall Similarity</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value green-stat" id="greenSections">0</div>
                    <div class="stat-label">Matching Sections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value yellow-stat" id="yellowSections">0</div>
                    <div class="stat-label">Comment Differences</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value orange-stat" id="orangeSections">0</div>
                    <div class="stat-label">Different Sections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value red-stat" id="redSections">0</div>
                    <div class="stat-label">Very Different/Missing</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let oldFileContent = '';
        let newFileContent = '';
        let detectedLanguage = '';
        let comparisonResults = null;

        // File upload handlers
        document.getElementById('oldFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('oldFileName').textContent = file.name;
                const reader = new FileReader();
                reader.onload = function (e) {
                    oldFileContent = e.target.result;
                };
                reader.readAsText(file);
            }
        });

        document.getElementById('newFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('newFileName').textContent = file.name;
                const reader = new FileReader();
                reader.onload = function (e) {
                    newFileContent = e.target.result;
                };
                reader.readAsText(file);
            }
        });

        // Language detection
        function detectLanguage(filename, content) {
            const ext = filename.split('.').pop().toLowerCase();
            const extMap = {
                'py': 'python',
                'js': 'javascript',
                'jsx': 'javascript',
                'ts': 'typescript',
                'tsx': 'typescript',
                'java': 'java',
                'cpp': 'cpp',
                'c': 'c',
                'cs': 'csharp',
                'rb': 'ruby',
                'php': 'php',
                'go': 'go',
                'rs': 'rust',
                'swift': 'swift',
                'kt': 'kotlin',
                'html': 'html',
                'css': 'css',
                'sql': 'sql',
                'sh': 'bash',
                'bash': 'bash'
            };
            return extMap[ext] || 'unknown';
        }

        // Get comment syntax for language
        function getCommentSyntax(language) {
            const syntax = {
                'python': { single: '#', multi: { start: '"""', end: '"""' } },
                'javascript': { single: '//', multi: { start: '/*', end: '*/' } },
                'typescript': { single: '//', multi: { start: '/*', end: '*/' } },
                'java': { single: '//', multi: { start: '/*', end: '*/' } },
                'cpp': { single: '//', multi: { start: '/*', end: '*/' } },
                'c': { single: '//', multi: { start: '/*', end: '*/' } },
                'csharp': { single: '//', multi: { start: '/*', end: '*/' } },
                'ruby': { single: '#', multi: { start: '=begin', end: '=end' } },
                'php': { single: '//', multi: { start: '/*', end: '*/' } },
                'go': { single: '//', multi: { start: '/*', end: '*/' } },
                'rust': { single: '//', multi: { start: '/*', end: '*/' } },
                'swift': { single: '//', multi: { start: '/*', end: '*/' } },
                'kotlin': { single: '//', multi: { start: '/*', end: '*/' } },
                'html': { single: null, multi: { start: '<!--', end: '-->' } },
                'css': { single: null, multi: { start: '/*', end: '*/' } },
                'sql': { single: '--', multi: { start: '/*', end: '*/' } },
                'bash': { single: '#', multi: null }
            };
            return syntax[language] || { single: '//', multi: { start: '/*', end: '*/' } };
        }

        // Normalize code by removing trivial differences
        function normalizeCode(code) {
            return code
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .join('\n');
        }

        // Extract comments from code
        function extractComments(code, language) {
            const syntax = getCommentSyntax(language);
            const comments = [];
            const lines = code.split('\n');

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Single line comments
                if (syntax.single && line.includes(syntax.single)) {
                    const commentStart = line.indexOf(syntax.single);
                    if (commentStart !== -1) {
                        comments.push({
                            line: i,
                            text: line.substring(commentStart),
                            type: 'single'
                        });
                    }
                }

                // Multi-line comments
                if (syntax.multi) {
                    if (line.includes(syntax.multi.start)) {
                        let commentText = line;
                        let j = i;
                        while (j < lines.length && !lines[j].includes(syntax.multi.end)) {
                            j++;
                            if (j < lines.length) commentText += '\n' + lines[j];
                        }
                        comments.push({
                            line: i,
                            text: commentText,
                            type: 'multi',
                            endLine: j
                        });
                    }
                }
            }

            return comments;
        }

        // Remove comments from code
        function removeComments(code, language) {
            const syntax = getCommentSyntax(language);
            let result = code;

            // Remove multi-line comments first
            if (syntax.multi) {
                const multiRegex = new RegExp(
                    syntax.multi.start.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') +
                    '[\\s\\S]*?' +
                    syntax.multi.end.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'),
                    'g'
                );
                result = result.replace(multiRegex, '');
            }

            // Remove single-line comments
            if (syntax.single) {
                const lines = result.split('\n');
                result = lines.map(line => {
                    const commentIndex = line.indexOf(syntax.single);
                    if (commentIndex !== -1) {
                        return line.substring(0, commentIndex);
                    }
                    return line;
                }).join('\n');
            }

            return result;
        }

        // Parse code into logical sections
        function parseIntoSections(code, language) {
            const lines = code.split('\n');
            const sections = [];
            let currentSection = [];
            let inFunction = false;
            let braceCount = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmed = line.trim();

                // Skip empty lines
                if (trimmed.length === 0) continue;

                currentSection.push(line);

                // Track braces for block detection
                braceCount += (line.match(/{/g) || []).length;
                braceCount -= (line.match(/}/g) || []).length;

                // Detect function/class boundaries
                const isFunctionStart = /^(function|def|class|public|private|protected|static)/.test(trimmed);
                const isBlockEnd = braceCount === 0 && trimmed.includes('}');

                // Create section at logical boundaries
                if ((isFunctionStart && currentSection.length > 1) ||
                    (isBlockEnd && braceCount === 0) ||
                    (trimmed.endsWith(';') && currentSection.length > 5)) {

                    if (currentSection.length > 0) {
                        sections.push(currentSection.join('\n'));
                        currentSection = [];
                    }
                }
            }

            // Add remaining lines
            if (currentSection.length > 0) {
                sections.push(currentSection.join('\n'));
            }

            return sections;
        }

        // Calculate similarity between two strings
        function calculateSimilarity(str1, str2) {
            const dmp = new diff_match_patch();
            const diffs = dmp.diff_main(str1, str2);
            dmp.diff_cleanupSemantic(diffs);

            let matches = 0;
            let total = 0;

            diffs.forEach(diff => {
                const length = diff[1].length;
                total += length;
                if (diff[0] === 0) { // Equal
                    matches += length;
                }
            });

            return total > 0 ? (matches / total) * 100 : 0;
        }

        // Compare two code sections
        function compareSections(oldSections, newSections, language) {
            const results = [];
            const oldComments = oldSections.map(s => extractComments(s, language));
            const newComments = newSections.map(s => extractComments(s, language));

            const maxSections = Math.max(oldSections.length, newSections.length);

            for (let i = 0; i < maxSections; i++) {
                const oldSection = i < oldSections.length ? oldSections[i] : '';
                const newSection = i < newSections.length ? newSections[i] : '';

                const oldWithoutComments = removeComments(normalizeCode(oldSection), language);
                const newWithoutComments = removeComments(normalizeCode(newSection), language);

                const oldHasComments = oldComments[i] && oldComments[i].length > 0;
                const newHasComments = newComments[i] && newComments[i].length > 0;

                let category = 'green';
                let similarity = calculateSimilarity(oldWithoutComments, newWithoutComments);

                // Determine category
                if (oldSection === '' || newSection === '') {
                    category = 'red';
                } else if (similarity < 40) {
                    category = 'red';
                } else if (similarity >= 40 && similarity < 80) {
                    category = 'orange';
                } else if (similarity >= 80) {
                    if (oldHasComments !== newHasComments) {
                        category = 'yellow';
                    } else {
                        category = 'green';
                    }
                }

                results.push({
                    number: i + 1,
                    oldCode: oldSection,
                    newCode: newSection,
                    category: category,
                    similarity: similarity,
                    oldHasComments: oldHasComments,
                    newHasComments: newHasComments,
                    commentDiff: oldHasComments !== newHasComments
                });
            }

            return results;
        }

        // Render comparison results
        function renderComparison(results) {
            const container = document.getElementById('comparisonContent');
            container.innerHTML = '';

            const oldPanel = document.createElement('div');
            oldPanel.className = 'code-panel';
            const newPanel = document.createElement('div');
            newPanel.className = 'code-panel';

            results.forEach(result => {
                // Old file section
                const oldSection = document.createElement('div');
                oldSection.className = `code-section ${result.category}`;

                let oldContent = `<div class="section-number">#${result.number}</div>`;

                if (result.oldCode === '') {
                    oldContent += `<div class="label-text" style="background: #f8d7da; color: #721c24;">MISSING</div>`;
                } else if (result.category === 'red' && result.newCode !== '') {
                    oldContent += `<div class="label-text" style="background: #f8d7da; color: #721c24;">VERY DIFFERENT</div>`;
                } else if (result.category === 'orange') {
                    oldContent += `<div class="label-text" style="background: #ffe8cc; color: #856404;">DIFFERENT</div>`;
                }

                if (result.commentDiff && !result.oldHasComments && result.newHasComments) {
                    oldContent += `<div class="label-text" style="background: #fff3cd; color: #856404;">MISSING COMMENT</div>`;
                }

                oldContent += `<div class="code-block">${escapeHtml(result.oldCode)}</div>`;
                oldSection.innerHTML = oldContent;
                oldPanel.appendChild(oldSection);

                // New file section
                const newSection = document.createElement('div');
                newSection.className = `code-section ${result.category}`;

                let newContent = `<div class="section-number">#${result.number}</div>`;

                if (result.newCode === '') {
                    newContent += `<div class="label-text" style="background: #f8d7da; color: #721c24;">MISSING</div>`;
                } else if (result.category === 'red' && result.oldCode !== '') {
                    newContent += `<div class="label-text" style="background: #f8d7da; color: #721c24;">VERY DIFFERENT</div>`;
                } else if (result.category === 'orange') {
                    newContent += `<div class="label-text" style="background: #ffe8cc; color: #856404;">DIFFERENT</div>`;
                }

                if (result.commentDiff && result.oldHasComments && !result.newHasComments) {
                    newContent += `<div class="label-text" style="background: #fff3cd; color: #856404;">MISSING COMMENT</div>`;
                }

                newContent += `<div class="code-block">${escapeHtml(result.newCode)}</div>`;
                newSection.innerHTML = newContent;
                newPanel.appendChild(newSection);
            });

            container.appendChild(oldPanel);
            container.appendChild(newPanel);
        }

        // Calculate and render statistics
        function renderStatistics(results) {
            const stats = {
                green: 0,
                yellow: 0,
                orange: 0,
                red: 0,
                totalLines: 0,
                similarity: 0
            };

            results.forEach(result => {
                stats[result.category]++;
                stats.totalLines += result.oldCode.split('\n').length + result.newCode.split('\n').length;
                stats.similarity += result.similarity;
            });

            stats.similarity = (stats.similarity / results.length).toFixed(1);

            document.getElementById('totalLines').textContent = stats.totalLines;
            document.getElementById('similarity').textContent = stats.similarity + '%';
            document.getElementById('greenSections').textContent = stats.green;
            document.getElementById('yellowSections').textContent = stats.yellow;
            document.getElementById('orangeSections').textContent = stats.orange;
            document.getElementById('redSections').textContent = stats.red;
        }

        // HTML escape helper
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Main comparison function
        function compareFiles() {
            if (!oldFileContent || !newFileContent) {
                alert('Please upload both files first!');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('comparisonContainer').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'none';

            setTimeout(() => {
                const languageSelect = document.getElementById('languageSelect').value;

                if (languageSelect === 'auto') {
                    const oldFileName = document.getElementById('oldFileName').textContent;
                    detectedLanguage = detectLanguage(oldFileName, oldFileContent);
                    document.getElementById('detectedLang').textContent = `Detected: ${detectedLanguage}`;
                    document.getElementById('detectedLang').style.display = 'inline-block';
                } else if (languageSelect === 'idk') {
                    detectedLanguage = 'unknown';
                    document.getElementById('detectedLang').textContent = 'Language: Unknown';
                    document.getElementById('detectedLang').style.display = 'inline-block';
                } else {
                    detectedLanguage = languageSelect;
                }

                const oldSections = parseIntoSections(oldFileContent, detectedLanguage);
                const newSections = parseIntoSections(newFileContent, detectedLanguage);

                comparisonResults = compareSections(oldSections, newSections, detectedLanguage);

                renderComparison(comparisonResults);
                renderStatistics(comparisonResults);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('comparisonContainer').style.display = 'block';
                document.getElementById('statsContainer').style.display = 'block';
                document.getElementById('downloadBtn').style.display = 'inline-block';
            }, 100);
        }

        // PDF download function
        function downloadPDF() {
            if (!comparisonResults) {
                alert('Please compare files first!');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yPosition = 20;
            const pageHeight = doc.internal.pageSize.height;
            const lineHeight = 7;
            const margin = 20;

            // Title
            doc.setFontSize(20);
            doc.text('Code Comparison Report', margin, yPosition);
            yPosition += 15;

            // Stats
            doc.setFontSize(12);
            doc.text(`Language: ${detectedLanguage}`, margin, yPosition);
            yPosition += lineHeight;
            doc.text(`Overall Similarity: ${document.getElementById('similarity').textContent}`, margin, yPosition);
            yPosition += lineHeight;
            doc.text(`Total Lines: ${document.getElementById('totalLines').textContent}`, margin, yPosition);
            yPosition += lineHeight * 2;

            // Section counts
            doc.text(`Matching: ${document.getElementById('greenSections').textContent}`, margin, yPosition);
            yPosition += lineHeight;
            doc.text(`Comment Differences: ${document.getElementById('yellowSections').textContent}`, margin, yPosition);
            yPosition += lineHeight;
            doc.text(`Different: ${document.getElementById('orangeSections').textContent}`, margin, yPosition);
            yPosition += lineHeight;
            doc.text(`Very Different/Missing: ${document.getElementById('redSections').textContent}`, margin, yPosition);
            yPosition += lineHeight * 2;

            // Sections
            doc.setFontSize(14);
            doc.text('Detailed Comparison', margin, yPosition);
            yPosition += lineHeight * 2;

            doc.setFontSize(10);
            comparisonResults.forEach((result, index) => {
                if (yPosition > pageHeight - 40) {
                    doc.addPage();
                    yPosition = 20;
                }

                const categoryText = {
                    'green': 'MATCH',
                    'yellow': 'COMMENT DIFF',
                    'orange': 'DIFFERENT',
                    'red': 'VERY DIFFERENT/MISSING'
                };

                doc.text(`Section #${result.number} - ${categoryText[result.category]}`, margin, yPosition);
                yPosition += lineHeight;

                if (result.oldCode) {
                    const oldLines = doc.splitTextToSize(`Old: ${result.oldCode.substring(0, 200)}...`, 170);
                    doc.text(oldLines, margin, yPosition);
                    yPosition += oldLines.length * lineHeight;
                }

                if (result.newCode) {
                    const newLines = doc.splitTextToSize(`New: ${result.newCode.substring(0, 200)}...`, 170);
                    doc.text(newLines, margin, yPosition);
                    yPosition += newLines.length * lineHeight;
                }

                yPosition += lineHeight;
            });

            doc.save('code-comparison-report.pdf');
        }
    </script>
</body>

</html>